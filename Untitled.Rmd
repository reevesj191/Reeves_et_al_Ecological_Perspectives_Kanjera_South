---
title: "Kanjera South Figures"
author: "Jonathan Reeves"
date: "2/1/2021"
output: pdf_document
---

```{r step up, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)

tiff_figures = TRUE

library(ggplot2)
library(grid)
library(gridExtra)
library(dplyr)
library(dunn.test)
library(raster)
library(ggplot2)
library(ggsn)
library(ggsflabel)
library(ggrepel)
library(sf)
library(ggnewscale)
```


```{r cores prep}
cores <- read.csv("Data/CORES_2019_JHE_With_REDUX.csv")
cores$RM <- toupper(cores$RM)

levels(cores$DeLaTorre.Typology)
### Reorder factor levels
# cores$DeLaTorre.Typology <- factor(as.character(cores$DeLaTorre.Typology), 
#                                    levels = c("unifacial simple partial",
#                                               "unidirectional abrupt unipolar", 
#                                               "unidirectional abrupt bipolar",
#                                               "bidirectional abrupt",
#                                               "bifacial partial",
#                                               "unifacial centripetal",
#                                               "bifacial centripetal",
#                                               "polyhedral",
#                                               "multifacial irregular"))

cores$rm.provenance <- "Distant"
cores$rm.provenance[cores$RM %in% c("HLI", "FNY", "HPH")] <- "Local"
cores$RM <- factor(cores$RM, levels = c("BBA", "BFE", "BQU", "NYR","OGR", "NYC", "HLI", "HPH", "FNY"))

cores_table <- cores %>% dplyr::group_by(RM) %>%
   dplyr::summarise("N" = dplyr::n(),
                    "Avg. Length" = round(mean(Axis1),2),
                    "Avg. Width" = round(mean(Axis2),2),
                    "Avg. Thickness" = round(mean(Axis3),2),
                    "Avg. Mass (g)" = round(mean(Mass),3),
                    "Avg. number of flake scars" = round(mean(FlakScars, na.rm = TRUE)), 
                    "Avg. Exploitation Surfaces" = round(mean(ExploitationSurfaces, na.rm = TRUE)),
                    "Avg. Surfarce Interactions" = round(mean(Interactions, na.rm = TRUE)),
                    "Avg. Percent Mass Lost" = round(mean(fixedpredict * 100))
)

kable(cores_table,caption = "Table 2")
```

```{r flake prep}

flakes <- read.csv("Data/kjs_flakes.csv")

flakes_table <- flakes %>% dplyr::group_by(Raw.Material) %>%
   dplyr::summarise("N" = dplyr::n(),
                    "Avg. Length" = round(mean(Length),2),
                    "Avg. Width" = round(mean(Length),2),
                    "Avg. Mass (g)" = round(mean(Mass),3),
                    "Avg. number of platform facets" = round(mean(Platform.facets)),
                    "Avg. number of dorsal scars" = round(mean(N.Flake.Scars)), 
                    "Avg. number of dorsal directions" = round(mean(Flake.scar.direction)),
                    "Avg. average percent cortex" = round(mean(Percent.Cortex),2),
                    "Avg. Flake Sequence" = round(mean(flake.seq))
)

kable(flakes_table, caption = "Table 3")
```


```{r fig-1, fig.height=5, fig.width=7, fig.cap= "A map of the Homa Peninsula. Kanjera South is situated to the East of Homa Mountain. The Homa Mountain carbonatite center is the primary source of the local raw materials including Homa limestone (HLi), Homa Phonolite (HPh), and Fenetized nyanzian rocks (FNy). Distant or exotic raw materials originate much farther to the east but they can be found in drainages east of the Samanga Fault. These include Bukoban andesite (BBa), Bukoban felsite (BFe), Bukoban quartzite (BQu), Nyanzian rhyolite (NyR), and Oygus granite (OGr)  \\label{map}" }


dem <- raster("Figures/Figure_data/Homa_Penninsula_DEM_30m2.tif")

dem[dem$Homa_Penninsula_DEM_30m2 <= 1134] <- NA
slope <- raster::terrain(dem, opt = "slope")
aspect <- terrain(dem, opt = "aspect")
dem <- data.frame(rasterToPoints(dem))
hs <- hillShade(slope = slope,
                aspect = aspect,
                angle = 50,
                direction = 315,
                normalize = TRUE)

hs <- data.frame(rasterToPoints(hs))

water <- read_sf("Figures/Figure_data/ke_major-rivers.shp")
kjs <- read_sf("Figures/Figure_data/KJS_WSG_84.shp")
rivers2<-read_sf("Figures/Figure_data/Rivers_homa_WGS2.shp")
fault <- read_sf("Figures/Figure_data/SamangaFault_WGS.shp")
st_geometry(kjs) <- NULL

ggplot()+
   geom_raster(data = hs,aes(x=x, y=y, fill = layer),show.legend = FALSE)+
   
   scale_fill_gradientn(colours = grey.colors(100,start = .5, end = 0))+
   
   new_scale_fill()+
   
   geom_raster(data = dem[dem$Homa_Penninsula_DEM_30m2 > 1134 & dem$Homa_Penninsula_DEM_30m2 < 2000,],
               aes(x=x,y=y,fill = Homa_Penninsula_DEM_30m2),alpha = .4, inherit.aes = FALSE)+
  
  #geom_sf(data = water, color = "dodger blue1")+
  
  geom_sf(data = rivers2, color = "dodger blue2")+
  
  geom_sf(data = fault,linetype =2) +
  geom_sf_text(data = fault, aes(label = "Samanga Fault"), angle = 47, nudge_y = -.015)+ 
      
   scale_fill_gradientn(colours = terrain.colors(100), "Elevation (m)")+
  
    geom_point(data = kjs, aes(x= X, y = Y)) +
   
   geom_label_repel(data= kjs, aes(x = X, y = Y,label = Local),
                  box.padding   = 1, 
                  point.padding = .5,
                  segment.color = 'black',
                  color = "black")+
   
   north(location = "bottomleft", symbol = 10, x.min = 34.43,x.max = 34.9, y.min = -0.525, y.max = -.27195)+
   
   scalebar(location = "bottomleft",dist_unit = "km",dist = 4, x.min = 34.44,x.max = 34.9, y.min = -0.528, y.max = -.275, transform = TRUE,st.dist = .025) + 
   
   scale_x_continuous(limits = c(34.42,34.8), expand = c(0,0))+
   
   scale_y_continuous(limits = c(-0.55,-.275), expand = c(0,0))+
   
   theme(panel.background = element_rect(fill = "dodger blue1"),
         panel.grid = element_blank(),
         panel.spacing = unit(1, "cm"),
         axis.text = element_blank(),
         axis.title = element_blank(),
         axis.ticks = element_blank())


```


```{r fig-2, echo=FALSE, warning=FALSE, , fig.cap="Examples of the found at Kanjera South. (A) Core produced on Homa limestone. (B) Core produced on Oyugis granite. (C) Core produced on Bukoban quartzite. (D) Core produced on Fenetized nyanzian.  \\label{tools}", paged.print=FALSE}
library(png)
library(grid)

  figure_03 = readPNG("Figures/KJS_Lithics_Fig_PNG.png")
  g <- rasterGrob(figure_03, interpolate=TRUE)
  ggplot(NULL, aes(NULL, NULL)) + geom_blank() + xlab('') + ylab('') +
    annotation_custom(g, xmin=-Inf, xmax=Inf, ymin=-Inf, ymax=Inf)+
    theme(panel.background = element_blank())
```


```{r fig-3, echo = FALSE, warnings=FALSE, dpi= 1000,fig.height= 3, fig.width= 6, fig.cap= "The distribution of core reduction intensity values as predicted by the GLMM (Douglass et al 2018). The results show stark differences in the degree of reduction in materials originating from more distant sources than those that originate from local sources of stone. \\label{core_redux_rm}"}

a <- ggplot(cores, aes(x = RM, y = fixedpredict, fill = rm.provenance)) + 
   geom_boxplot(show.legend = FALSE) + 
   scale_fill_manual(values = c("#E69F00", "#56B4E9"))+
   scale_y_continuous(limits = c(0,1))+
   labs(x = "Raw Material", y = "Reduction intensity (% Mass Lost)") +
   theme(panel.background = element_rect(color = "black", fill = "white"))


b <- ggplot(cores, aes(x = rm.provenance, y = fixedpredict, fill = rm.provenance)) + 
   geom_boxplot(show.legend = FALSE) + 
   scale_fill_manual(values = c("#E69F00", "#56B4E9"))+
   scale_y_continuous(limits = c(0,1))+
   labs(x = "Raw Material Provenance", y = "Reduction intensity (% Mass Lost)")+
   theme(panel.background = element_rect(color = "black", fill = "white"))


   
grid.arrange(a,b, ncol = 2)

```

```{r fig-4, fig.height=3, fig.width=5, warning=FALSE, echo=FALSE, fig.cap= "The distribution of flake sequence values present within the Kanjera South flake assemblage. The primary differences in flake sequence values are between materials originating from more distant sources than those that originate from local sources of stone. \\label{flake_seq_rm}"}
### Doing Sequence the old way since there are currently problems with the GLMM ###

  ggplot(flakes, aes(x = Raw.Material, y = flake.stage, fill = rm.provenance)) + 
   geom_boxplot()+
   scale_fill_manual(values = c("#E69F00", "#56B4E9"))+
   labs(x = "Raw Material", y = "Flake Sequence")+
   guides(fill=guide_legend(title="Raw Material Provenance")) +
   theme(panel.background = element_rect(color = "black", fill = "white"),
         legend.position = "right")
```
# Statistical Tests

## The significance of cores reduction intensity by raw material Provenance

```{r}
wilcox.test(cores$fixedpredict~cores$rm.provenance)
```


## The significance of core reduction strategies according to raw material Provenance
```{r}
cores.table <- table(cores$rm.provenance,cores$DeLaTorre.Typology)
kable(cores.table)
```

### Fishers Exact Test
```{r}

res <- fisher.test(cores.table, simulate.p.value = TRUE)
res
```

## The significance of flake sequence according to raw material Provenance 
```{r}
wilcox.test(flakes$flake.stage~
             flakes$rm.provenance)
```